name: Publish Release

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  # Publish to crates.io (Rust)
  publish-rust:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        run: cargo publish --token "${{ secrets.CARGO_TOKEN }}"
        if: secrets.CARGO_TOKEN != ''

  # Publish to PyPI (Python) - Multi-platform wheels
  build-python-wheels:
    name: Build Python wheels
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux wheels
          - os: ubuntu-latest
            python-version: "3.11"
            target: x86_64-unknown-linux-gnu
          # macOS Intel
          - os: macos-latest
            python-version: "3.11"
            target: x86_64-apple-darwin
          # macOS ARM64 (Apple Silicon)
          - os: macos-latest
            python-version: "3.11"
            target: aarch64-apple-darwin
          # Windows x86_64
          - os: windows-latest
            python-version: "3.11"
            target: x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Rust toolchain for macOS ARM64
        if: matrix.target == 'aarch64-apple-darwin'
        run: rustup target add aarch64-apple-darwin

      - name: Install maturin
        run: pip install maturin

      - name: Build wheels
        run: maturin build --release --target ${{ matrix.target }}

      - name: Upload wheels as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-wheels-${{ matrix.target }}
          path: target/wheels/
          retention-days: 5
          if-no-files-found: warn

  # Publish all Python wheels to PyPI
  publish-python:
    name: Publish Python to PyPI
    runs-on: ubuntu-latest
    needs: build-python-wheels
    steps:
      - uses: actions/checkout@v4

      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-wheels
          pattern: python-wheels-*

      - name: Organize wheels
        run: |
          mkdir -p wheels
          find all-wheels -type f -name "*.whl" -exec cp {} wheels/ \;

          echo "=== Downloaded wheels ==="
          ls -lh wheels/
          wheel_count=$(find wheels -name "*.whl" | wc -l)
          echo "Total wheels found: $wheel_count"
          if [ "$wheel_count" -lt 4 ]; then
            echo "Warning: Expected at least 4 wheels, found $wheel_count"
          fi

      - name: Install build dependencies
        run: pip install twine

      - name: Publish to PyPI
        if: secrets.MATURIN_PYPI_TOKEN != ''
        run: |
          twine upload wheels/* \
            -u __token__ \
            -p "${{ secrets.MATURIN_PYPI_TOKEN }}" \
            --skip-existing \
            --non-interactive

  # Publish to npm (Node.js)
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          registry-url: 'https://registry.npmjs.org'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        working-directory: ./bindings/node
        run: npm ci

      - name: Build
        working-directory: ./bindings/node
        run: npm run build

      - name: Publish
        working-directory: ./bindings/node
        if: secrets.NPM_TOKEN != ''
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Create release summary
  release-summary:
    name: Create Release Summary
    runs-on: ubuntu-latest
    needs: [publish-rust, publish-python, publish-npm]
    if: always() && !cancelled()
    steps:
      - uses: actions/checkout@v4

      - name: Create release summary
        run: |
          echo "âœ… Release Publishing Summary"
          echo "=============================="
          echo ""
          echo "Registry Publishing Status:"
          echo "  Rust (crates.io): ${{ needs.publish-rust.result }}"
          echo "  Python (PyPI): ${{ needs.publish-python.result }}"
          echo "  Node.js (npm): ${{ needs.publish-npm.result }}"
          echo ""
          echo "For Java and C# bindings:"
          echo "  ðŸ”§ Currently skipped (add when needed)"
          echo ""
          if [[ "${{ needs.publish-rust.result }}" == "success" && "${{ needs.publish-python.result }}" == "success" && "${{ needs.publish-npm.result }}" == "success" ]]; then
            echo "âœ… All enabled registries published successfully!"
          else
            echo "âš ï¸  Some publishing steps were skipped or failed"
            echo "    Check GitHub Secrets configuration"
          fi

  # Verify published packages
  verify:
    name: Verify Published Packages
    runs-on: ubuntu-latest
    needs: [publish-rust, publish-python, publish-npm]
    if: always() && !cancelled()
    steps:
      - name: Verify crates.io
        if: needs.publish-rust.result == 'success'
        run: |
          cargo search meta-oxide --limit 1 || echo "Package may take time to appear on crates.io"

      - name: Verify PyPI
        if: needs.publish-python.result == 'success'
        run: |
          pip index versions meta-oxide 2>/dev/null || echo "Package may take time to appear on PyPI"

      - name: Verify npm
        if: needs.publish-npm.result == 'success'
        run: |
          npm view meta-oxide-node 2>/dev/null || echo "Package may take time to appear on npm"
